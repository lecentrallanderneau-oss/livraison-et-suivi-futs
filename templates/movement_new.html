{% extends "base.html" %}
{% block title %}Nouveau mouvement{% endblock %}
{% block content %}
<h5 class="mb-3">Livraison / Reprise</h5>
<form method="post" class="card p-3 bg-white">
  {% if current_client %}
    <input type="hidden" name="client_id" value="{{ current_client.id }}">
    <div class="mb-2"><span class="badge bg-secondary">Client sélectionné : {{ current_client.name }}</span></div>
  {% else %}
  <div class="mb-2">
    <label class="form-label">Client</label>
    <select name="client_id" class="form-select form-select-lg" required>
      {% for c in clients %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="mb-2">
    <label class="form-label">Type</label>
    <select name="type" class="form-select form-select-lg" required>
      <option value="OUT">Livraison</option>
      <option value="IN">Reprise</option>
      <option value="DEFECT">Reprise défectueux</option>
    </select>
  </div>

  <div class="mb-2">
    <label class="form-label">Date & heure</label>
    <input type="datetime-local" name="when" class="form-control form-control-lg" />
    <div class="form-text">Laisse vide pour “maintenant”.</div>
  </div>

  <div class="mb-2">
    <label class="form-label">Produit & format (catalogue)</label>
    <select name="variant_id" class="form-select form-select-lg">
      <option value="">— (aucun, matériel seul) —</option>
      {% for v in variants %}
        <option value="{{ v.id }}">{{ v.name }} — {{ v.size_l }} L{% if v.price_ttc %} ({{ '%.2f'|format(v.price_ttc) }} €){% endif %}</option>
      {% endfor %}
    </select>
    <div class="form-text">
      Règles: Coreff Ambrée → 22L ; Coreff Rousse → 20L.  
      <strong>OU</strong> saisir une référence <em>hors catalogue</em> ci-dessous, <strong>OU</strong> rien si c’est du matériel seul.
    </div>
  </div>

  <div class="border rounded p-2 mb-2">
    <div class="mb-1 fw-semibold">Référence hors catalogue (optionnel)</div>
    <div class="row g-2">
      <div class="col-12">
        <label class="form-label">Nom du produit</label>
        <input type="text" name="custom_name" class="form-control form-control-lg" placeholder="ex: Coreff Triple édition spéciale">
      </div>
      <div class="col-6">
        <label class="form-label">Format (L)</label>
        <input type="number" name="custom_size_l" class="form-control form-control-lg" min="1" step="1" placeholder="ex: 20">
      </div>
      <div class="col-6">
        <label class="form-label">Prix unitaire bière TTC (€)</label>
        <input type="number" step="0.01" name="unit_price_ttc" class="form-control form-control-lg" placeholder="auto si vide (catalogue)">
      </div>
    </div>
    <div class="form-text">Si “Nom du produit” est rempli, on crée/ajoute au catalogue automatiquement.</div>
  </div>

  <div class="row">
    <div class="col-6 mb-2">
      <label class="form-label">Quantité de fûts</label>
      <input type="number" name="qty" class="form-control form-control-lg" value="0" min="0">
      <div class="form-text">Mets 0 si tu prêtes/reprends seulement du matériel.</div>
    </div>
    <div class="col-6 mb-2">
      <label class="form-label">Consigne / fût (€)</label>
      <input type="number" step="0.01" name="deposit_per_keg" class="form-control form-control-lg" value="30">
      <div class="form-text">Ignoré si quantité = 0.</div>
    </div>
  </div>

  <div class="border rounded p-2 mb-3">
    <div class="mb-1 fw-semibold">Matériel prêté / repris (sans valeur €)</div>
    <div class="row g-2">
      <div class="col-6">
        <label class="form-label">Tireuse(s)</label>
        <input type="number" name="eq_tireuse" class="form-control form-control-lg" value="0" min="0">
      </div>
      <div class="col-6">
        <label class="form-label">CO₂ (bouteilles)</label>
        <input type="number" name="eq_co2" class="form-control form-control-lg" value="0" min="0">
      </div>
      <div class="col-6">
        <label class="form-label">Comptoir(s)</label>
        <input type="number" name="eq_comptoir" class="form-control form-control-lg" value="0" min="0">
      </div>
      <div class="col-6">
        <label class="form-label">Tonnelle(s)</label>
        <input type="number" name="eq_tonnelle" class="form-control form-control-lg" value="0" min="0">
      </div>
      <div class="col-12">
        <label class="form-label">Ecocup (gobelets)</label>
        <input type="number" name="eq_ecocup" class="form-control form-control-lg" value="0" min="0">
        <div class="form-text">
          Livraison: facture lavage 0,10 €/gobelet. Reprise: si moins rendu que chez le client, facture 1€/gobelet manquant.
        </div>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Notes</label>
    <input name="notes" class="form-control form-control-lg" placeholder="ex: 50 Ecocup prêtés">
  </div>

  <button class="btn btn-primary btn-lg w-100">Enregistrer</button>
</form>
{% endblock %}
