{% extends "base.html" %}
{% block title %}{{ client.name }} · Gestion fûts{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between">
  <h1 class="h3">{{ client.name }}</h1>
  <a class="btn btn-primary" href="{{ url_for('movement_new', client_id=client.id) }}">Nouveau mouvement</a>
</div>
<hr>

<div class="row g-3">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="mb-2"><span class="muted">Bière facturée cumulée</span><div class="card-number">{{ '%.2f'|format(beer_billed_cum or 0) }} €</div></div>
        <div class="mb-2"><span class="muted">Consigne en cours</span><div class="card-number">{{ '%.2f'|format(deposit_in_play or 0) }} €</div></div>
        <div class="mb-2"><span class="muted">Litres livrés cumulés</span><div class="card-number">{{ delivered_qty_cum or 0 }} L</div></div>
        <div class="mb-2"><span class="muted">Volume actuellement en place</span><div class="card-number">{{ in_place_total or 0 }} L</div></div>
        <hr>
        <div class="mb-1"><span class="muted">Dernière livraison</span><div>{{ last_delivery_at or '—' }}</div></div>
        <div class="mb-1"><span class="muted">Dernier retrait</span><div>{{ last_pickup_at or '—' }}</div></div>
        <hr>
        <div class="mb-1"><span class="muted">Matériel en prêt</span></div>
        <ul class="list-unstyled mb-0">
          <li>Tireuse : <strong>{{ equipment_totals.tireuse or 0 }}</strong></li>
          <li>CO₂ : <strong>{{ equipment_totals.co2 or 0 }}</strong></li>
          <li>Comptoir : <strong>{{ equipment_totals.comptoir or 0 }}</strong></li>
          <li>Tonnelle : <strong>{{ equipment_totals.tonnelle or 0 }}</strong></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="col-md-9">
    <div class="card mb-3">
      <div class="card-header">Stock par variantes</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Contenance</th>
              <th class="text-end">Sorties</th>
              <th class="text-end">Entrées/Defect</th>
              <th class="text-end">En place (est.)</th>
              <th class="text-end">Prix cat. (€)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set en_place = (r.out_qty or 0) - (r.in_qty or 0) %}
              <tr>
                <td>{{ r.product_name }}</td>
                <td>{{ r.size_l }} L</td>
                <td class="text-end">{{ r.out_qty or 0 }}</td>
                <td class="text-end">{{ r.in_qty or 0 }}</td>
                <td class="text-end">{{ en_place }}</td>
                <td class="text-end">{{ '%.2f'|format(r.catalog_price or 0) }}</td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="text-center text-muted">Aucune donnée.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Historique des mouvements</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Produit</th>
              <th class="text-end">Taille</th>
              <th class="text-end">Qté</th>
              <th class="text-end">Prix unitaire</th>
              <th class="text-end">Consigne/ fût</th>
              <th>Matériel</th>
              <th>Note</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for m in movements %}
              <tr>
                <td class="text-nowrap">{{ m.when.strftime('%Y-%m-%d %H:%M') if m.when else '—' }}</td>
                <td>{{ m.type }}</td>
                <td>{{ m.product }}</td>
                <td class="text-end">{{ m.size_l }} L</td>
                <td class="text-end">{{ m.qty }}</td>
                <td class="text-end">{{ m.unit_price is not none and ('%.2f'|format(m.unit_price)) or '—' }}</td>
                <td class="text-end">{{ m.deposit_per_keg and ('%.2f'|format(m.deposit_per_keg)) or '—' }}</td>
                <td>
                  {% set e = m.equipment %}
                  {% if e.tireuse or e.co2 or e.comptoir or e.tonnelle %}
                    <small class="muted">
                      {% if e.tireuse %} tireuse={{ e.tireuse }}{% endif %}
                      {% if e.co2 %} co2={{ e.co2 }}{% endif %}
                      {% if e.comptoir %} comptoir={{ e.comptoir }}{% endif %}
                      {% if e.tonnelle %} tonnelle={{ e.tonnelle }}{% endif %}
                    </small>
                  {% else %}—{% endif %}
                </td>
                <td>{{ m['note'] or '' }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-danger" href="{{ url_for('movement_confirm_delete', movement_id=m.id) }}">Supprimer</a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="10" class="text-center text-muted">Aucun mouvement.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
{% endblock %}
